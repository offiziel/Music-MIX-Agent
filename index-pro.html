<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI MIXING ASSISTANT PRO 3.0 - Ultimate Edition</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 100%);
            color: #e0e0e0;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }

        /* Neon Glows */
        .glow-text { text-shadow: 0 0 10px rgba(0, 242, 255, 0.5); }
        .glow-box { box-shadow: 0 0 15px rgba(0, 242, 255, 0.1); transition: box-shadow 0.3s; }
        .glow-box:hover { box-shadow: 0 0 25px rgba(0, 242, 255, 0.2); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00f2ff; }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* Knob Styles - IMPROVED */
        .knob-wrapper {
            position: relative;
            width: 70px;
            height: 70px;
            cursor: grab;
            user-select: none;
        }
        .knob-wrapper:active { cursor: grabbing; }

        .knob-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(from 180deg, #00f2ff var(--deg), #1a1a1a 0);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8), 0 2px 8px rgba(0,242,255,0.3);
            position: relative;
            transition: transform 0.1s, box-shadow 0.3s;
        }
        .knob-wrapper:hover .knob-circle {
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8), 0 4px 16px rgba(0,242,255,0.5);
        }
        .knob-wrapper:active .knob-circle { transform: scale(0.98); }

        .knob-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 75%;
            height: 75%;
            background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: #00f2ff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .knob-indicator {
            position: absolute;
            top: 8%;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 15%;
            background: #ff0055;
            border-radius: 2px;
            box-shadow: 0 0 8px #ff0055;
        }

        /* Audio Spectrum Canvas */
        .spectrum-canvas {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 12px;
            border: 1px solid #1F2937;
        }

        /* Meter Styles */
        .meter-bg {
            background: #05070A;
            border: 1px solid #1F2937;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }
        .meter-fill {
            height: 100%;
            transition: width 0.1s;
            background: linear-gradient(90deg, #10B981, #F59E0B, #EF4444);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #00f2ff;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,242,255,0.3);
            animation: slideIn 0.3s ease-out;
            z-index: 9999;
        }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }

        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; }
        .prose strong { color: #00f2ff; font-weight: 600; }
        .prose ul { list-style: disc; padding-left: 1.2em; color: #aaa; margin: 0.5em 0; }
        .prose li { margin: 0.3em 0; }
        .prose code { background: #000; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }

        /* Loading Spinner */
        .spinner {
            border: 2px solid #333;
            border-top: 2px solid #00f2ff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Upload Drop Zone */
        .drop-zone {
            border: 2px dashed #333;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .drop-zone:hover, .drop-zone.drag-over {
            border-color: #00f2ff;
            background: rgba(0, 242, 255, 0.05);
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- CONFIG ---
        const API_BASE = 'http://localhost:3001/api';

        // --- ICONS ---
        const Icon = ({ name, size=20, className="" }) => {
            const props = { xmlns:"http://www.w3.org/2000/svg", width:size, height:size, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", className };

            if(name==='mic') return <svg {...props}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>;
            if(name==='sliders') return <svg {...props}><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>;
            if(name==='bot') return <svg {...props}><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>;
            if(name==='zap') return <svg {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
            if(name==='save') return <svg {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
            if(name==='download') return <svg {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
            if(name==='upload') return <svg {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
            if(name==='settings') return <svg {...props}><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/></svg>;
            if(name==='check') return <svg {...props}><polyline points="20 6 9 17 4 12"/></svg>;
            if(name==='x') return <svg {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
            if(name==='play') return <svg {...props}><polygon points="5 3 19 12 5 21 5 3"/></svg>;
            if(name==='pause') return <svg {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>;
            if(name==='music') return <svg {...props}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>;
            return null;
        };

        // --- STORAGE MANAGER ---
        const StorageManager = {
            save: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch(e) { console.error('Storage error:', e); }
            },
            load: (key, defaultVal) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultVal;
                } catch(e) { return defaultVal; }
            }
        };

        // --- API CONFIG ---
        const API_CONFIG = {
            getKey: () => {
                let key = StorageManager.load('gemini_api_key', '');
                if (!key) {
                    key = ""; // ‚¨ÖÔ∏è FALLBACK: Hier API Key eintragen
                }
                return key;
            },
            setKey: (key) => StorageManager.save('gemini_api_key', key)
        };

        async function callGemini(prompt, systemContext, retries = 2) {
            const apiKey = API_CONFIG.getKey();
            if (!apiKey) return { error: true, message: "‚ö†Ô∏è **DEMO MODE**: Bitte API Key in den Settings eintragen." };

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [{ text: `SYSTEM: ${systemContext}\n\nUSER: ${prompt}` }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 1024
                }
            };

            for(let i = 0; i <= retries; i++) {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload),
                        signal: AbortSignal.timeout(15000)
                    });

                    if (!res.ok) {
                        const error = await res.json();
                        if (res.status === 401) return { error: true, message: "üîë **API Key ung√ºltig**. Bitte in den Settings pr√ºfen." };
                        if (res.status === 429) return { error: true, message: "‚è±Ô∏è **Rate Limit**. Warte kurz und versuch's nochmal." };
                        return { error: true, message: `API Fehler: ${error.error?.message || 'Unbekannt'}` };
                    }

                    const data = await res.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) return { error: true, message: "Keine Antwort von AI erhalten." };

                    return { error: false, message: text };
                } catch (e) {
                    if (i === retries) return { error: true, message: `Netzwerkfehler: ${e.message}` };
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
        }

        // --- TOAST NOTIFICATION ---
        const Toast = ({ message, type = 'info', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const colors = {
                success: 'border-green-500 text-green-400',
                error: 'border-red-500 text-red-400',
                info: 'border-[#00f2ff] text-[#00f2ff]'
            };

            return (
                <div className={`toast ${colors[type]}`}>
                    <div className="flex items-center gap-2">
                        {type === 'success' && <Icon name="check" size={16} />}
                        {type === 'error' && <Icon name="x" size={16} />}
                        <span className="text-sm font-semibold">{message}</span>
                    </div>
                </div>
            );
        };

        // --- IMPROVED KNOB COMPONENT ---
        const Knob = ({ label, val, setVal, min = 0, max = 100, unit = "%" }) => {
            const [isDragging, setIsDragging] = useState(false);
            const startY = useRef(0);
            const startVal = useRef(0);

            const handleMouseDown = (e) => {
                setIsDragging(true);
                startY.current = e.clientY;
                startVal.current = val;
                e.preventDefault();
            };

            const handleMouseMove = useCallback((e) => {
                if (!isDragging) return;
                const delta = startY.current - e.clientY;
                const sensitivity = 0.5;
                let newVal = startVal.current + (delta * sensitivity);
                newVal = Math.max(min, Math.min(max, newVal));
                setVal(Math.round(newVal));
            }, [isDragging, min, max, setVal]);

            const handleMouseUp = useCallback(() => {
                setIsDragging(false);
            }, []);

            useEffect(() => {
                if (isDragging) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    return () => {
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    };
                }
            }, [isDragging, handleMouseMove, handleMouseUp]);

            const rotation = ((val - min) / (max - min)) * 270 - 135;

            return (
                <div className="flex flex-col items-center gap-2">
                    <div className="knob-wrapper" onMouseDown={handleMouseDown}>
                        <div
                            className="knob-circle"
                            style={{
                                '--deg': `${((val - min) / (max - min)) * 360}deg`,
                                transform: `rotate(${rotation}deg)`,
                                transition: isDragging ? 'none' : 'transform 0.2s ease-out'
                            }}
                        >
                            <div className="knob-indicator"></div>
                        </div>
                        <div className="knob-inner" style={{ transform: 'translate(-50%, -50%) rotate(0deg)' }}>
                            {Math.round(val)}{unit}
                        </div>
                    </div>
                    <span className="text-[10px] uppercase text-gray-400 font-bold tracking-wider">{label}</span>
                </div>
            );
        };

        // --- SPECTRUM ANALYZER COMPONENT ---
        const SpectrumAnalyzer = ({ analyser, isPlaying, style }) => {
            const canvasRef = useRef(null);
            const animationRef = useRef(null);

            const STYLE_COLORS = {
                aggro: '#EF4444',
                emo: '#8B5CF6',
                story: '#10B981'
            };

            useEffect(() => {
                if (!analyser || !isPlaying) return;

                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                const draw = () => {
                    animationRef.current = requestAnimationFrame(draw);

                    analyser.getByteFrequencyData(dataArray);

                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    const barWidth = (canvas.width / bufferLength) * 2.5;
                    let x = 0;

                    for (let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * canvas.height;
                        const color = STYLE_COLORS[style] || '#00f2ff';

                        ctx.fillStyle = color;
                        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                        x += barWidth + 1;
                    }
                };

                draw();

                return () => {
                    if (animationRef.current) {
                        cancelAnimationFrame(animationRef.current);
                    }
                };
            }, [analyser, isPlaying, style]);

            return (
                <canvas
                    ref={canvasRef}
                    className="spectrum-canvas"
                    width={800}
                    height={200}
                />
            );
        };

        // --- AUDIO PLAYER COMPONENT ---
        const AudioPlayer = ({ style, showToast }) => {
            const [audioFile, setAudioFile] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [audioData, setAudioData] = useState({ peak: -60, lufs: -60, bpm: 0 });
            const [analysis, setAnalysis] = useState(null);

            const audioContext = useRef(null);
            const analyser = useRef(null);
            const source = useRef(null);

            const handleFileUpload = async (file) => {
                if (!file) return;

                setAudioFile(file);
                setIsAnalyzing(true);
                showToast(`Analyzing: ${file.name}`, 'info');

                try {
                    // Initialize Web Audio API
                    if (!audioContext.current) {
                        audioContext.current = new (window.AudioContext || window.webkitAudioContext)();
                    }

                    // Decode audio file
                    const arrayBuffer = await file.arrayBuffer();
                    const audioBuffer = await audioContext.current.decodeAudioData(arrayBuffer);

                    // Create source and analyser
                    if (source.current) source.current.stop();

                    source.current = audioContext.current.createBufferSource();
                    source.current.buffer = audioBuffer;

                    analyser.current = audioContext.current.createAnalyser();
                    analyser.current.fftSize = 2048;

                    source.current.connect(analyser.current);
                    analyser.current.connect(audioContext.current.destination);

                    // Upload to backend for analysis
                    const formData = new FormData();
                    formData.append('audio', file);

                    const response = await fetch(`${API_BASE}/analysis/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.error) {
                        showToast(result.message, 'error');
                    } else {
                        setAnalysis(result.data);
                        setAudioData({
                            peak: result.data.loudness.peak_dbfs,
                            lufs: result.data.loudness.integrated_lufs,
                            bpm: result.data.bpm
                        });
                        showToast('Audio analyzed successfully!', 'success');
                    }

                    setIsAnalyzing(false);
                } catch (error) {
                    console.error('Audio processing error:', error);
                    showToast(`Error: ${error.message}`, 'error');
                    setIsAnalyzing(false);
                }
            };

            const togglePlayback = () => {
                if (!source.current) return;

                if (isPlaying) {
                    source.current.stop();
                    setIsPlaying(false);
                } else {
                    source.current.start(0);
                    setIsPlaying(true);
                    startMetering();
                }
            };

            const startMetering = () => {
                if (!analyser.current) return;

                const dataArray = new Uint8Array(analyser.current.frequencyBinCount);

                const updateMeters = () => {
                    analyser.current.getByteFrequencyData(dataArray);

                    const peak = Math.max(...dataArray) / 255;
                    const peakDb = 20 * Math.log10(peak || 0.001);
                    const lufsEstimate = peakDb + 8; // Simplified estimation

                    setAudioData(prev => ({
                        ...prev,
                        peak: peakDb.toFixed(1),
                        lufs: lufsEstimate.toFixed(1)
                    }));

                    if (isPlaying) {
                        requestAnimationFrame(updateMeters);
                    }
                };

                updateMeters();
            };

            return (
                <div className="space-y-6">
                    {/* Upload Zone */}
                    <div
                        className="drop-zone"
                        onClick={() => document.getElementById('audio-upload').click()}
                    >
                        <Icon name="upload" size={48} className="mx-auto mb-4 text-gray-500" />
                        <h3 className="text-xl font-bold text-white mb-2">Drop Audio File Here</h3>
                        <p className="text-sm text-gray-400">or click to browse</p>
                        <p className="text-xs text-gray-600 mt-2">Supported: WAV, MP3, M4A, OGG, FLAC</p>
                        <input
                            id="audio-upload"
                            type="file"
                            accept="audio/*"
                            className="hidden"
                            onChange={(e) => handleFileUpload(e.target.files[0])}
                        />
                    </div>

                    {/* Audio Info */}
                    {audioFile && (
                        <div className="bg-[#111] border border-[#333] rounded-lg p-4">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                    <Icon name="music" size={24} className="text-[#00f2ff]" />
                                    <div>
                                        <h4 className="font-bold text-white">{audioFile.name}</h4>
                                        <p className="text-xs text-gray-500">
                                            {(audioFile.size / 1024 / 1024).toFixed(2)} MB
                                            {analysis && ` ‚Ä¢ ${analysis.duration}s ‚Ä¢ ${analysis.bpm} BPM ‚Ä¢ ${analysis.key}`}
                                        </p>
                                    </div>
                                </div>
                                <button
                                    onClick={togglePlayback}
                                    disabled={isAnalyzing}
                                    className="bg-[#00f2ff] hover:bg-white text-black p-3 rounded-lg transition disabled:opacity-50"
                                >
                                    <Icon name={isPlaying ? 'pause' : 'play'} size={20} />
                                </button>
                            </div>

                            {isAnalyzing && (
                                <div className="flex items-center justify-center gap-2 text-gray-400">
                                    <span className="spinner"></span>
                                    <span className="text-sm">Analyzing audio...</span>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Spectrum Analyzer */}
                    {audioFile && (
                        <SpectrumAnalyzer analyser={analyser.current} isPlaying={isPlaying} style={style} />
                    )}

                    {/* Meters */}
                    {audioFile && (
                        <div className="grid grid-cols-3 gap-4">
                            <div className="bg-[#111] border border-[#333] rounded-lg p-4">
                                <h5 className="text-xs text-gray-500 uppercase mb-2">Peak Level</h5>
                                <p className="text-2xl font-bold text-[#00f2ff]">{audioData.peak} dB</p>
                                <div className="meter-bg mt-2">
                                    <div
                                        className="meter-fill"
                                        style={{width: `${Math.min(100, (parseFloat(audioData.peak)+60)*1.6)}%`}}
                                    ></div>
                                </div>
                            </div>

                            <div className="bg-[#111] border border-[#333] rounded-lg p-4">
                                <h5 className="text-xs text-gray-500 uppercase mb-2">LUFS</h5>
                                <p className="text-2xl font-bold text-emerald-400">{audioData.lufs} LUFS</p>
                                <div className="meter-bg mt-2">
                                    <div
                                        className="meter-fill"
                                        style={{width: `${Math.min(100, (parseFloat(audioData.lufs)+60)*1.6)}%`}}
                                    ></div>
                                </div>
                            </div>

                            <div className="bg-[#111] border border-[#333] rounded-lg p-4">
                                <h5 className="text-xs text-gray-500 uppercase mb-2">BPM</h5>
                                <p className="text-2xl font-bold text-purple-400">{audioData.bpm}</p>
                                <p className="text-xs text-gray-500 mt-2">
                                    {analysis && `DR: ${analysis.loudness.dynamic_range} dB`}
                                </p>
                            </div>
                        </div>
                    )}

                    {/* Analysis Details */}
                    {analysis && (
                        <div className="bg-gradient-to-br from-[#1a1a1a] to-[#111] border border-[#333] rounded-lg p-6">
                            <h4 className="font-bold text-white mb-4 flex items-center gap-2">
                                <Icon name="zap" /> AI Analysis Results
                            </h4>
                            <div className="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <h5 className="text-[#00f2ff] font-semibold mb-2">Loudness</h5>
                                    <ul className="space-y-1 text-gray-400">
                                        <li>‚Ä¢ Integrated: {analysis.loudness.integrated_lufs} LUFS</li>
                                        <li>‚Ä¢ True Peak: {analysis.loudness.true_peak_dbtp} dBTP</li>
                                        <li>‚Ä¢ Dynamic Range: {analysis.loudness.dynamic_range} dB</li>
                                        <li>‚Ä¢ LRA: {analysis.loudness.loudness_range} LU</li>
                                    </ul>
                                </div>
                                <div>
                                    <h5 className="text-[#00f2ff] font-semibold mb-2">Frequency</h5>
                                    <ul className="space-y-1 text-gray-400">
                                        <li>‚Ä¢ Dominant: {analysis.frequency.dominant_freq} Hz</li>
                                        <li>‚Ä¢ Centroid: {analysis.frequency.spectral_centroid} Hz</li>
                                        <li>‚Ä¢ Stereo Width: {analysis.spatial.stereo_width}</li>
                                    </ul>
                                </div>
                            </div>
                            {analysis.recommendations && (
                                <div className="mt-4 pt-4 border-t border-[#333]">
                                    <h5 className="text-emerald-400 font-semibold mb-2">Recommendations</h5>
                                    <p className="text-sm text-gray-400 mb-2">
                                        Suggested Style: <span className="text-white font-bold uppercase">{analysis.recommendations.suggested_style}</span>
                                        {' ‚Ä¢ '}
                                        Quality Score: <span className="text-[#00f2ff] font-bold">{analysis.recommendations.quality_score}/100</span>
                                    </p>
                                    <ul className="space-y-1 text-xs text-gray-400">
                                        {analysis.recommendations.needs_improvement.map((rec, i) => (
                                            <li key={i}>{rec}</li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- PRESET MANAGER ---
        const PRESETS = {
            aggro: {
                eq: { k1: 30, k2: 40, k3: 70, k4: 20 },
                comp: { k1: 65, k2: 70, k3: 15, k4: 55 },
                sat: { k1: 45, k2: 50, k3: 40, k4: 30 }
            },
            emo: {
                eq: { k1: 40, k2: 60, k3: 50, k4: 65 },
                comp: { k1: 50, k2: 50, k3: 25, k4: 45 },
                sat: { k1: 25, k2: 30, k3: 35, k4: 40 }
            },
            story: {
                eq: { k1: 35, k2: 55, k3: 45, k4: 40 },
                comp: { k1: 55, k2: 60, k3: 20, k4: 50 },
                sat: { k1: 30, k2: 35, k3: 30, k4: 25 }
            }
        };

        // --- VST RACK COMPONENT ---
        const VSTRack = ({ title, type, style, knobsState, setKnobsState }) => {
            const [aiAdvice, setAiAdvice] = useState(null);
            const [loading, setLoading] = useState(false);

            const knobLabels = {
                eq: ['Low Cut', 'Low Mid', 'High Mid', 'Air'],
                comp: ['Threshold', 'Ratio', 'Attack', 'Makeup'],
                sat: ['Drive', 'Tone', 'Mix', 'Output'],
                fx: ['Depth', 'Rate', 'Feedback', 'Mix'],
                limit: ['Threshold', 'Ceiling', 'Release', 'Gain']
            };

            const labels = knobLabels[type] || ['Param 1', 'Param 2', 'Param 3', 'Param 4'];

            const handleAnalyze = async () => {
                setLoading(true);

                const styleNames = { aggro: 'AGGRESSIV', emo: 'EMOTIONAL', story: 'STORYTELLING' };
                const prompt = `Analysiere meine aktuellen Settings und gib mir konkrete Verbesserungsvorschl√§ge f√ºr '${title}' im ${styleNames[style]}-Style.

                Aktuelle Werte:
                - ${labels[0]}: ${knobsState.k1}%
                - ${labels[1]}: ${knobsState.k2}%
                - ${labels[2]}: ${knobsState.k3}%
                - ${labels[3]}: ${knobsState.k4}%

                Format: 3-4 konkrete Bulletpoints mit Werten (Hz, dB, ms).`;

                const result = await callGemini(
                    prompt,
                    "Du bist ein erfahrener Audio Engineer spezialisiert auf Deutschrap. Sei spezifisch und technisch pr√§zise."
                );

                if (result.error) {
                    setAiAdvice(`<p class="text-red-400">${result.message}</p>`);
                } else {
                    setAiAdvice(marked.parse(result.message));

                    if (PRESETS[style] && PRESETS[style][type]) {
                        setTimeout(() => {
                            setKnobsState(PRESETS[style][type]);
                        }, 500);
                    }
                }

                setLoading(false);
            };

            return (
                <div className="bg-gradient-to-br from-[#1a1a1a] to-[#111] border border-[#333] rounded-lg p-4 mb-4 glow-box">
                    <div className="flex justify-between items-center mb-4 border-b border-[#333] pb-2">
                        <h3 className="font-bold text-[#00f2ff] tracking-widest text-sm">{title}</h3>
                        <button
                            onClick={handleAnalyze}
                            disabled={loading}
                            className="text-xs bg-[#00f2ff] text-black px-3 py-1.5 rounded font-bold hover:bg-white transition flex items-center gap-1.5 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {loading ? <><span className="spinner"></span> ANALYZING...</> : <><Icon name="zap" size={12}/> AI-OPTIMIZE</>}
                        </button>
                    </div>

                    <div className="flex justify-around mb-4">
                        {Object.keys(knobsState).map((key, idx) => (
                            <Knob
                                key={key}
                                label={labels[idx]}
                                val={knobsState[key]}
                                setVal={(v) => setKnobsState({ ...knobsState, [key]: v })}
                            />
                        ))}
                    </div>

                    {aiAdvice && (
                        <div className="bg-slate-900/50 backdrop-blur p-3 rounded border border-slate-700/50 text-xs text-gray-300 prose prose-invert max-w-none"
                             dangerouslySetInnerHTML={{__html: aiAdvice}}>
                        </div>
                    )}
                </div>
            );
        };

        // --- SETTINGS MODAL ---
        const SettingsModal = ({ isOpen, onClose, currentApiKey, onSaveApiKey }) => {
            const [apiKey, setApiKey] = useState(currentApiKey);

            if (!isOpen) return null;

            const handleSave = () => {
                onSaveApiKey(apiKey);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-[#1a1a1a] border border-[#333] rounded-xl p-6 max-w-md w-full mx-4" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 pb-3 border-b border-[#333]">
                            <h2 className="text-xl font-bold text-[#00f2ff] flex items-center gap-2">
                                <Icon name="settings" size={20} /> Einstellungen
                            </h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-white">
                                <Icon name="x" size={20} />
                            </button>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-400 mb-2">
                                    Google Gemini API Key
                                </label>
                                <input
                                    type="password"
                                    value={apiKey}
                                    onChange={e => setApiKey(e.target.value)}
                                    className="w-full bg-[#0a0a0a] border border-[#333] rounded px-3 py-2 text-white focus:border-[#00f2ff] outline-none"
                                    placeholder="AIza..."
                                />
                                <p className="text-xs text-gray-500 mt-1">
                                    Hol dir einen kostenlosen Key auf <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-[#00f2ff] hover:underline">Google AI Studio</a>
                                </p>
                            </div>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 bg-[#333] hover:bg-[#444] text-white py-2 rounded font-semibold transition">
                                Abbrechen
                            </button>
                            <button onClick={handleSave} className="flex-1 bg-[#00f2ff] hover:bg-white text-black py-2 rounded font-semibold transition">
                                Speichern
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [step, setStep] = useState(StorageManager.load('current_step', 1));
            const [style, setStyle] = useState(StorageManager.load('selected_style', ""));
            const [tracks, setTracks] = useState(StorageManager.load('tracks', { main: true, doubles: false, adlibs: false }));
            const [fx, setFx] = useState(StorageManager.load('fx', { autotune: false, delay: false, reverb: false }));

            // VST States
            const [eqKnobs, setEqKnobs] = useState(StorageManager.load('eq_knobs', { k1: 50, k2: 50, k3: 50, k4: 50 }));
            const [compKnobs, setCompKnobs] = useState(StorageManager.load('comp_knobs', { k1: 50, k2: 50, k3: 50, k4: 50 }));
            const [satKnobs, setSatKnobs] = useState(StorageManager.load('sat_knobs', { k1: 50, k2: 50, k3: 50, k4: 50 }));
            const [fxKnobs, setFxKnobs] = useState(StorageManager.load('fx_knobs', { k1: 50, k2: 50, k3: 50, k4: 50 }));
            const [limitKnobs, setLimitKnobs] = useState(StorageManager.load('limit_knobs', { k1: 50, k2: 50, k3: 50, k4: 50 }));

            // Chat State
            const [chatOpen, setChatOpen] = useState(false);
            const [messages, setMessages] = useState(StorageManager.load('chat_history', [
                {role: 'ai', text: 'Yo! üëã Ich bin dein AI Studio-Assistent. Lade ein Audio-File hoch oder frag mich was!'}
            ]));
            const [chatInput, setChatInput] = useState("");
            const chatEndRef = useRef(null);

            // Settings
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [apiKey, setApiKey] = useState(API_CONFIG.getKey());

            // Toast
            const [toast, setToast] = useState(null);

            // Auto-save to localStorage
            useEffect(() => {
                StorageManager.save('current_step', step);
                StorageManager.save('selected_style', style);
                StorageManager.save('tracks', tracks);
                StorageManager.save('fx', fx);
                StorageManager.save('eq_knobs', eqKnobs);
                StorageManager.save('comp_knobs', compKnobs);
                StorageManager.save('sat_knobs', satKnobs);
                StorageManager.save('fx_knobs', fxKnobs);
                StorageManager.save('limit_knobs', limitKnobs);
                StorageManager.save('chat_history', messages);
            }, [step, style, tracks, fx, eqKnobs, compKnobs, satKnobs, fxKnobs, limitKnobs, messages]);

            // Auto-scroll chat
            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const showToast = (message, type = 'info') => {
                setToast({ message, type });
            };

            const handleChat = async (e) => {
                e.preventDefault();
                if(!chatInput.trim()) return;

                const newMsgs = [...messages, {role: 'user', text: chatInput}];
                setMessages(newMsgs);
                setChatInput("");

                const styleNames = { aggro: 'AGGRESSIV', emo: 'EMOTIONAL', story: 'STORYTELLING' };
                const context = `
                    AKTUELLER SESSION-STATUS:
                    - Style: ${styleNames[style] || 'Nicht gew√§hlt'}
                    - Aktive Spuren: ${Object.entries(tracks).filter(([k,v]) => v).map(([k]) => k).join(', ')}
                    - Aktive FX: ${Object.entries(fx).filter(([k,v]) => v).map(([k]) => k).join(', ')}
                    - EQ: Low=${eqKnobs.k1}% Mid=${eqKnobs.k2}% High=${eqKnobs.k3}% Air=${eqKnobs.k4}%
                    - Comp: Thr=${compKnobs.k1}% Ratio=${compKnobs.k2}% Atk=${compKnobs.k3}% Gain=${compKnobs.k4}%

                    Du bist ein hilfsbereiter, lockerer Deutschrap-Produzenten-Mentor. Antworte konkret und praxisnah.
                `;

                const result = await callGemini(chatInput, context);
                const aiResponse = result.error ? result.message : result.message;
                setMessages([...newMsgs, {role: 'ai', text: aiResponse}]);
            };

            const exportSettings = () => {
                const data = {
                    version: '3.0',
                    style,
                    tracks,
                    fx,
                    vstSettings: { eq: eqKnobs, comp: compKnobs, sat: satKnobs, fx: fxKnobs, limit: limitKnobs }
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mix-preset-${style}-${Date.now()}.json`;
                a.click();
                showToast('Settings exportiert!', 'success');
            };

            const importSettings = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        setStyle(data.style || style);
                        setTracks(data.tracks || tracks);
                        setFx(data.fx || fx);
                        if (data.vstSettings) {
                            setEqKnobs(data.vstSettings.eq || eqKnobs);
                            setCompKnobs(data.vstSettings.comp || compKnobs);
                            setSatKnobs(data.vstSettings.sat || satKnobs);
                            setFxKnobs(data.vstSettings.fx || fxKnobs);
                            setLimitKnobs(data.vstSettings.limit || limitKnobs);
                        }
                        showToast('Settings importiert!', 'success');
                        setStep(3);
                    } catch (err) {
                        showToast('Fehler beim Import!', 'error');
                    }
                };
                reader.readAsText(file);
            };

            const applyPreset = () => {
                if (!style || !PRESETS[style]) return;
                const preset = PRESETS[style];
                setEqKnobs(preset.eq);
                setCompKnobs(preset.comp);
                setSatKnobs(preset.sat);
                showToast(`${style.toUpperCase()}-Preset angewendet!`, 'success');
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row">

                    {/* SIDEBAR */}
                    <div className="w-full md:w-64 bg-gradient-to-b from-[#0a0a0a] to-[#1a0a1a] border-r border-[#222] p-6 flex flex-col">
                        <div className="mb-8">
                            <h1 className="text-3xl font-black text-white italic mb-2">AI<span className="text-[#00f2ff]">MIX</span></h1>
                            <p className="text-xs text-gray-500 uppercase tracking-wider">Pro 3.0 Ultimate</p>
                        </div>

                        <nav className="space-y-3">
                            <div
                                className={`p-3 rounded-lg cursor-pointer transition ${step===1 ? 'bg-[#00f2ff]/20 text-[#00f2ff] border border-[#00f2ff] glow-box' : 'text-gray-500 hover:text-white hover:bg-[#222]'}`}
                                onClick={()=>setStep(1)}
                            >
                                <div className="font-bold">1. VIBE & STYLE</div>
                                <div className="text-[10px] opacity-70">W√§hle deinen Sound</div>
                            </div>
                            <div
                                className={`p-3 rounded-lg cursor-pointer transition ${step===2 ? 'bg-[#00f2ff]/20 text-[#00f2ff] border border-[#00f2ff] glow-box' : style ? 'text-gray-500 hover:text-white hover:bg-[#222]' : 'text-gray-700 cursor-not-allowed'}`}
                                onClick={()=>style && setStep(2)}
                            >
                                <div className="font-bold">2. AUDIO LAB</div>
                                <div className="text-[10px] opacity-70">Upload & Analyze</div>
                            </div>
                            <div
                                className={`p-3 rounded-lg cursor-pointer transition ${step===3 ? 'bg-[#00f2ff]/20 text-[#00f2ff] border border-[#00f2ff] glow-box' : style ? 'text-gray-500 hover:text-white hover:bg-[#222]' : 'text-gray-700 cursor-not-allowed'}`}
                                onClick={()=>style && setStep(3)}
                            >
                                <div className="font-bold">3. MIXING</div>
                                <div className="text-[10px] opacity-70">AI-powered Console</div>
                            </div>
                        </nav>

                        <div className="mt-auto space-y-3">
                            {step === 3 && (
                                <>
                                    <button onClick={applyPreset} className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white p-2.5 rounded-lg font-semibold text-sm transition flex items-center justify-center gap-2">
                                        <Icon name="zap" size={16} /> Quick Preset
                                    </button>
                                    <button onClick={exportSettings} className="w-full bg-[#222] hover:bg-[#333] text-white p-2.5 rounded-lg font-semibold text-sm transition flex items-center justify-center gap-2">
                                        <Icon name="download" size={16} /> Export
                                    </button>
                                    <label className="w-full bg-[#222] hover:bg-[#333] text-white p-2.5 rounded-lg font-semibold text-sm transition flex items-center justify-center gap-2 cursor-pointer">
                                        <Icon name="upload" size={16} /> Import
                                        <input type="file" accept=".json" onChange={importSettings} className="hidden" />
                                    </label>
                                </>
                            )}

                            <button onClick={()=>setChatOpen(!chatOpen)} className="w-full bg-gradient-to-r from-[#00f2ff] to-[#0099cc] hover:from-[#00d9e6] hover:to-[#0088bb] text-black p-3 rounded-lg flex items-center justify-center gap-2 transition font-bold">
                                <Icon name="bot" size={18} /> {chatOpen ? "Chat schlie√üen" : "AI Mentor"}
                            </button>

                            <button onClick={() => setSettingsOpen(true)} className="w-full bg-[#1a1a1a] hover:bg-[#222] text-gray-400 hover:text-white p-2.5 rounded-lg font-semibold text-sm transition flex items-center justify-center gap-2">
                                <Icon name="settings" size={16} /> Settings
                            </button>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-1 p-8 overflow-y-auto relative">

                        {/* STEP 1: STYLE */}
                        {step === 1 && (
                            <div className="fade-in max-w-4xl mx-auto">
                                <h2 className="text-5xl font-black text-white mb-3 glow-text">W√§hle deinen Style</h2>
                                <p className="text-gray-400 mb-8">Der Style bestimmt deine Mixing-Philosophie und AI-Vorschl√§ge</p>

                                <div className="grid md:grid-cols-3 gap-6">
                                    {[
                                        {
                                            id: 'aggro',
                                            name: 'AGGRESSIV',
                                            bpm: '140-160',
                                            desc: 'Harter Stra√üenrap, trocken, In-your-face Vocals.',
                                            color: 'from-red-600 to-orange-600',
                                            icon: 'üî•'
                                        },
                                        {
                                            id: 'emo',
                                            name: 'EMOTIONAL',
                                            bpm: '90-110',
                                            desc: 'Viel Hall, melodische Vocals, Deep Vibes.',
                                            color: 'from-blue-600 to-purple-600',
                                            icon: 'üíô'
                                        },
                                        {
                                            id: 'story',
                                            name: 'STORYTELLING',
                                            bpm: '85-95',
                                            desc: 'Fokus auf Stimme und Klarheit, wenig Effekte.',
                                            color: 'from-green-600 to-teal-600',
                                            icon: 'üìñ'
                                        }
                                    ].map(s => (
                                        <div
                                            key={s.id}
                                            onClick={()=>{
                                                setStyle(s.id);
                                                setStep(2);
                                                showToast(`${s.name}-Style gew√§hlt!`, 'success');
                                            }}
                                            className={`p-6 rounded-2xl border-2 cursor-pointer transition-all hover:scale-105 ${
                                                style===s.id
                                                    ? `bg-gradient-to-br ${s.color} border-white shadow-2xl`
                                                    : 'bg-[#1a1a1a] border-[#333] hover:border-[#00f2ff] glow-box'
                                            }`}
                                        >
                                            <div className="text-4xl mb-3">{s.icon}</div>
                                            <h3 className="text-2xl font-black mb-2">{s.name}</h3>
                                            <div className="text-xs font-mono bg-black/40 inline-block px-3 py-1 rounded-full mb-4">
                                                BPM: {s.bpm}
                                            </div>
                                            <p className="text-sm opacity-90 leading-relaxed">{s.desc}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* STEP 2: AUDIO LAB */}
                        {step === 2 && (
                            <div className="fade-in max-w-4xl mx-auto">
                                <h2 className="text-4xl font-black text-white mb-2 glow-text">Audio Lab</h2>
                                <p className="text-gray-400 mb-8">Upload dein Audio-File f√ºr AI-gest√ºtzte Analyse</p>

                                <AudioPlayer style={style} showToast={showToast} />

                                <div className="mt-8 flex justify-end">
                                    <button
                                        onClick={()=>setStep(3)}
                                        className="bg-gradient-to-r from-[#00f2ff] to-[#0099cc] text-black font-black py-3 px-8 rounded-xl hover:from-white hover:to-[#00f2ff] transition-all transform hover:scale-105"
                                    >
                                        ZUM MIXING ‚Üí
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* STEP 3: MIXING SUITE */}
                        {step === 3 && (
                            <div className="fade-in max-w-6xl mx-auto">
                                <header className="flex justify-between items-end mb-8 border-b border-[#333] pb-4">
                                    <div>
                                        <h2 className="text-5xl font-black text-white italic glow-text">MIXING CONSOLE</h2>
                                        <p className="text-gray-400 mt-2">
                                            Style: <span className="text-[#00f2ff] uppercase font-bold">{style}</span>
                                            {' ‚Ä¢ '}
                                            <span className="text-xs">Drag Knobs zum Einstellen</span>
                                        </p>
                                    </div>
                                    <button onClick={()=>setStep(2)} className="text-xs text-gray-500 hover:text-[#00f2ff] transition flex items-center gap-1">
                                        <Icon name="settings" size={14} /> ZUR√úCK ZU AUDIO LAB
                                    </button>
                                </header>

                                <div className="grid lg:grid-cols-2 gap-8">
                                    <div>
                                        <h3 className="text-white font-bold mb-4 flex items-center gap-2 text-lg">
                                            <Icon name="mic"/> MAIN VOCAL CHAIN
                                        </h3>
                                        <VSTRack
                                            title="1. SUBTRAKTIVER EQ"
                                            type="eq"
                                            style={style}
                                            knobsState={eqKnobs}
                                            setKnobsState={setEqKnobs}
                                        />
                                        <VSTRack
                                            title="2. KOMPRESSOR"
                                            type="comp"
                                            style={style}
                                            knobsState={compKnobs}
                                            setKnobsState={setCompKnobs}
                                        />
                                        <VSTRack
                                            title="3. SATURATION"
                                            type="sat"
                                            style={style}
                                            knobsState={satKnobs}
                                            setKnobsState={setSatKnobs}
                                        />
                                    </div>

                                    <div>
                                        <h3 className="text-white font-bold mb-4 flex items-center gap-2 text-lg">
                                            <Icon name="sliders"/> FX & MASTER
                                        </h3>
                                        {(fx.autotune || fx.delay || fx.reverb) && (
                                            <VSTRack
                                                title="FX CHAIN"
                                                type="fx"
                                                style={style}
                                                knobsState={fxKnobs}
                                                setKnobsState={setFxKnobs}
                                            />
                                        )}
                                        <VSTRack
                                            title="MASTER LIMITER"
                                            type="limit"
                                            style={style}
                                            knobsState={limitKnobs}
                                            setKnobsState={setLimitKnobs}
                                        />

                                        <div className="bg-gradient-to-br from-green-900/20 to-emerald-900/20 border border-green-700/50 rounded-lg p-4 mt-4">
                                            <h4 className="font-bold text-green-400 mb-2 flex items-center gap-2">
                                                <Icon name="zap" size={16} /> Quick Tips
                                            </h4>
                                            <ul className="text-xs text-gray-300 space-y-1">
                                                <li>‚Ä¢ Ziehe Knobs vertikal f√ºr pr√§zise Kontrolle</li>
                                                <li>‚Ä¢ Nutze "AI-OPTIMIZE" f√ºr Style-perfekte Settings</li>
                                                <li>‚Ä¢ Exportiere deine Settings als Preset</li>
                                                <li>‚Ä¢ Frag den AI Mentor bei Fragen!</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>

                    {/* AI CHAT OVERLAY */}
                    {chatOpen && (
                        <div className="fixed bottom-4 right-4 w-96 h-[500px] bg-gradient-to-br from-[#1a1a1a] to-[#0a0a0a] border border-[#00f2ff]/30 rounded-2xl shadow-2xl flex flex-col z-50 glow-box">
                            <div className="p-4 bg-gradient-to-r from-[#00f2ff]/20 to-[#0099cc]/20 border-b border-[#333] flex justify-between items-center rounded-t-2xl">
                                <span className="font-bold text-[#00f2ff] flex items-center gap-2">
                                    <Icon name="bot" size={18}/> AI PRODUCER MENTOR
                                </span>
                                <button onClick={()=>setChatOpen(false)} className="text-gray-400 hover:text-white transition">
                                    <Icon name="x" size={18} />
                                </button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {messages.map((m, i) => (
                                    <div
                                        key={i}
                                        className={`p-3 rounded-lg text-sm ${
                                            m.role==='ai'
                                                ? 'bg-[#222] text-gray-300 border border-[#333]'
                                                : 'bg-gradient-to-r from-[#00f2ff]/20 to-[#0099cc]/20 text-white ml-8 border border-[#00f2ff]/30'
                                        }`}
                                    >
                                        {m.role === 'ai' ? (
                                            <div className="prose prose-invert prose-sm max-w-none" dangerouslySetInnerHTML={{__html: marked.parse(m.text)}}></div>
                                        ) : (
                                            <div>{m.text}</div>
                                        )}
                                    </div>
                                ))}
                                <div ref={chatEndRef} />
                            </div>

                            <form onSubmit={handleChat} className="p-3 border-t border-[#333] flex gap-2">
                                <input
                                    value={chatInput}
                                    onChange={e=>setChatInput(e.target.value)}
                                    className="flex-1 bg-[#0a0a0a] border border-[#333] rounded-lg px-3 py-2 text-white text-sm focus:border-[#00f2ff] outline-none"
                                    placeholder="Frage deinen AI Mentor..."
                                />
                                <button
                                    type="submit"
                                    className="bg-gradient-to-r from-[#00f2ff] to-[#0099cc] hover:from-white hover:to-[#00f2ff] text-black px-4 py-2 rounded-lg font-bold text-sm transition"
                                >
                                    <Icon name="zap" size={16} />
                                </button>
                            </form>
                        </div>
                    )}

                    {/* Settings Modal */}
                    <SettingsModal
                        isOpen={settingsOpen}
                        onClose={() => setSettingsOpen(false)}
                        currentApiKey={apiKey}
                        onSaveApiKey={(key) => {
                            API_CONFIG.setKey(key);
                            setApiKey(key);
                            showToast('API Key gespeichert!', 'success');
                        }}
                    />

                    {/* Toast Notification */}
                    {toast && (
                        <Toast
                            message={toast.message}
                            type={toast.type}
                            onClose={() => setToast(null)}
                        />
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
